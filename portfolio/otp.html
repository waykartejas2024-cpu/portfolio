<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP Generator (Demo)</title>
    <style>
         :root {
            font-family: Segoe UI, Roboto, Arial, sans-serif;
            color: #222
        }
        
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f6f8fb;
            margin: 0
        }
        
        .card {
            background: white;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(20, 30, 50, 0.08);
            width: 360px;
            max-width: 90%
        }
        
        h1 {
            font-size: 18px;
            margin: 0 0 12px
        }
        
        p.lead {
            margin: 0 0 18px;
            color: #555;
            font-size: 14px
        }
        
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px
        }
        
        input[type="text"],
        input[type="tel"],
        input[type="number"] {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #d6dbe7
        }
        
        button {
            padding: 10px 12px;
            border-radius: 6px;
            border: 0;
            background: #2b6ef6;
            color: white;
            cursor: pointer
        }
        
        button.secondary {
            background: #f1f5f9;
            color: #111;
            border: 1px solid #dde6fb
        }
        
        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }
        
        .status {
            margin-top: 12px;
            font-size: 13px;
            color: #333
        }
        
        .muted {
            color: #777;
            font-size: 13px
        }
        
        .otp-box {
            margin: 12px 0;
            padding: 12px;
            border-radius: 8px;
            background: #f7fbff;
            border: 1px dashed #d7e6ff;
            text-align: center;
            font-weight: 700;
            letter-spacing: 4px;
            font-size: 20px
        }
        
        .small {
            font-size: 12px;
            color: #666
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>OTP Generator (client-side demo)</h1>
        <p class="lead">This demo generates a 6-digit OTP purely in the browser (for demo/testing only). It includes a 60s expiry, verify and resend controls.</p>

        <div class="row controls">
            <input id="destInput" type="text" placeholder="Enter phone or email (optional)" />
            <button id="generateBtn">Generate</button>
        </div>

        <div id="otpContainer" class="otp-box muted">No OTP generated</div>

        <div class="row">
            <input id="otpInput" type="text" placeholder="Enter OTP to verify" />
            <button id="verifyBtn" class="secondary">Verify</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <button id="resendBtn" class="secondary">Resend</button>
            <button id="revealBtn">Show</button>
            <div id="timer" class="muted small">--</div>
        </div>

        <div id="message" class="status"></div>
        <div class="small" style="margin-top:10px">Notes: OTP is stored in localStorage for this demo. Do not use client-only OTP for real authentication.</div>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const resendBtn = document.getElementById('resendBtn');
        const verifyBtn = document.getElementById('verifyBtn');
        const revealBtn = document.getElementById('revealBtn');
        const otpContainer = document.getElementById('otpContainer');
        const otpInput = document.getElementById('otpInput');
        const timerEl = document.getElementById('timer');
        const messageEl = document.getElementById('message');

        let timerHandle = null;

        // Client-only generator (kept for fallback)
        function generateOTPClient() {
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            const expiry = Date.now() + 60 * 1000; // 60s
            localStorage.setItem('demo_otp', otp);
            localStorage.setItem('demo_otp_expiry', expiry.toString());
            showMaskedOTP();
            startTimer(expiry);
            message('OTP generated — valid for 60 seconds. (client-only)', 'info');
            resendBtn.disabled = true;
        }

        // Server-backed send (calls /api/send-otp). If server isn't available, falls back to client generator.
        async function generateOTP() {
            const dest = document.getElementById('destInput').value.trim();
            if (!dest) {
                // no destination provided -> local generation
                generateOTPClient();
                return;
            }

            try {
                const resp = await fetch('/api/send-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: dest })
                });

                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    message(`Server error: ${err.error || resp.statusText}`, 'error');
                    // fallback
                    generateOTPClient();
                    return;
                }

                const data = await resp.json();
                if (data.success) {
                    if (data.sent) {
                        message('OTP sent by server. Check the destination (SMS/email).', 'info');
                        // we don't receive OTP from server in real mode
                        otpContainer.textContent = 'OTP sent (check your phone)';
                        otpContainer.classList.remove('muted');
                        timerEl.textContent = '--';
                        resendBtn.disabled = false; // server will manage sending again
                    } else if (data.otp) {
                        // demo mode: server returned the otp for convenience
                        const otp = data.otp.toString();
                        const expiry = Date.now() + 60 * 1000;
                        localStorage.setItem('demo_otp', otp);
                        localStorage.setItem('demo_otp_expiry', expiry.toString());
                        showMaskedOTP();
                        startTimer(expiry);
                        message('OTP generated on server (demo) — valid for 60 seconds.', 'info');
                        resendBtn.disabled = true;
                    } else {
                        message('OTP request accepted.', 'info');
                    }
                } else {
                    message('Server rejected OTP request', 'error');
                    generateOTPClient();
                }
            } catch (err) {
                // network or other error -> fallback to client-side generator
                console.warn('Server not reachable, falling back to client-only mode.', err);
                generateOTPClient();
            }
        }

        function showMaskedOTP() {
            const otp = localStorage.getItem('demo_otp');
            if (!otp) {
                otpContainer.textContent = 'No OTP generated';
                otpContainer.classList.add('muted');
                return;
            }
            // mask by default
            otpContainer.textContent = otp.replace(/.(?=.{2})/g, '*');
            otpContainer.classList.remove('muted');
        }

        function startTimer(expiry) {
            if (timerHandle) clearInterval(timerHandle);

            function tick() {
                const now = Date.now();
                const left = Math.max(0, Math.ceil((expiry - now) / 1000));
                timerEl.textContent = left > 0 ? `Expires in ${left}s` : 'Expired';
                if (left <= 0) {
                    clearInterval(timerHandle);
                    timerHandle = null;
                    message('OTP expired. You can resend.', 'error');
                    resendBtn.disabled = false;
                }
            }
            tick();
            timerHandle = setInterval(tick, 500);
        }

        function verifyOTP() {
            const saved = localStorage.getItem('demo_otp');
            const expiry = parseInt(localStorage.getItem('demo_otp_expiry') || '0', 10);
            const provided = (otpInput.value || '').trim();
            if (!saved) return message('No OTP generated. Click Generate first.', 'error');
            if (Date.now() > expiry) return message('OTP expired. Please resend.', 'error');
            if (!provided) return message('Please enter the OTP.', 'error');
            if (provided === saved) {
                message('✅ OTP verified — success!', 'success');
                // clear stored otp after successful verification (demo choice)
                localStorage.removeItem('demo_otp');
                localStorage.removeItem('demo_otp_expiry');
                showMaskedOTP();
                timerEl.textContent = '--';
                resendBtn.disabled = false;
            } else {
                message('Incorrect OTP. Try again.', 'error');
            }
        }

        function resendOTP() {
            // for demo, simply generate a fresh OTP
            generateOTP();
        }

        function message(text, type = 'info') {
            messageEl.textContent = text;
            messageEl.style.color = type === 'error' ? '#b00020' : (type === 'success' ? '#0a7a0a' : '#333');
        }

        // Reveal/Hide OTP for debugging/demo
        let revealed = false;

        function toggleReveal() {
            const otp = localStorage.getItem('demo_otp');
            if (!otp) return;
            revealed = !revealed;
            otpContainer.textContent = revealed ? otp : otp.replace(/.(?=.{2})/g, '*');
            revealBtn.textContent = revealed ? 'Hide' : 'Show';
        }

        // Init: if stored OTP exists and not expired, show and start timer
        (function init() {
            const saved = localStorage.getItem('demo_otp');
            const expiry = parseInt(localStorage.getItem('demo_otp_expiry') || '0', 10);
            if (saved && Date.now() < expiry) {
                showMaskedOTP();
                startTimer(expiry);
                resendBtn.disabled = true;
            } else {
                // cleanup stale
                localStorage.removeItem('demo_otp');
                localStorage.removeItem('demo_otp_expiry');
                showMaskedOTP();
                timerEl.textContent = '--';
                resendBtn.disabled = false;
            }
        })();

        // Event wiring
        generateBtn.addEventListener('click', generateOTP);
        verifyBtn.addEventListener('click', verifyOTP);
        resendBtn.addEventListener('click', resendOTP);
        revealBtn.addEventListener('click', toggleReveal);

        // allow Enter to verify
        otpInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') verifyOTP();
        });
    </script>
</body>

</html>